---
title: "Criminology Missingness Simulations"
author: "Ben Stockton"
date: "`r Sys.Date()`"
output: 
    pdf_document:
    number_sections: true 
    df_print: tibble
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = 'hold')
library(dplyr, warn.conflicts = FALSE)

# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
library(magrittr)
library(ggplot2)
library(latex2exp)
library(RColorBrewer)
library(readr)
library(cowplot)
library(doParallel)
library(forcats)

cores <- detectCores()
source("helpers.R")
```

```{r load-data}
dat <- read_csv("Data/simulated_data.csv", col_types = "dfdffffffdfdd")
```

```{r, echo = FALSE, results = 'hide'}
dat$OFF_RACER %<>% fct_relevel(c("WHITE", "BLACK", "LATINO", "OTHER"))
levels(dat$OFF_RACER)
```

Running similar simulations but now with the simulated criminology data set, so I'm not creating a new data set with each iteration to save time for now. The regression is now on all twelve predictors instead of just X and CTY. If a defendant doesn't meet the qualifications for missingness, we assume they are completely observed. Probability of missingness is set to get roughly 3-5% of defendants missing Race observations in the sample.

```{r load-cca-params}
load("full_data_cca_log_reg.rda")
beta <- coef(fit)
rm(fit)
```

```{r sim-params}
M <- 1000
a <- c(-6, -7); b <- c(4, 8)
Q <- 25 # Q * 5
replace <- FALSE
```

## MNAR

Want to get roughly 3% missing in OFF_RACER in both cases.

Overstate the Race effect: Missingness in Race is conditional on Race being non-White & not being incarcerated. $$P(\mathrm{RACE ~is ~Miss} ~|~ \mathrm{RACE ~is~not~WHITE}, ~\mathrm{INCAR} = 0) = .25$$

Understate the Race effect: Missingness in Race is conditional on Race being non-White & being incarcerated. $$P(\mathrm{OFF\_RACER ~is ~Miss} ~|~ \mathrm{OFF\_RACER ~is~not~WHITE}, ~\mathrm{INCAR} = 1) = .3$$

```{r}
source("helpers.R")
full_sim(miss_type = "MNAR", sim_size = "full", pop_data = dat,
             beta = beta, a = -7, b = 8, Q = 1, replace = replace)
```

```{r mnar-sim}
cl <- makeCluster(cores[1] - 1)
registerDoParallel(cl)
ptime <- system.time({
    mnar <- foreach(i = 1:5, .combine = rbind) %dopar% {
    source("helpers.R")
    full_sim(miss_type = "MNAR", sim_size = "full", pop_data = dat,
             beta = beta, a = a[1], b = b[1], Q = Q, replace = replace)
    }
})[3]
ptime
stopCluster(cl)
```

## MAR

Want to get roughly 3% missing in OFF_RACER in both cases.

Previously I had race determined by county, but I've since removed that since confounders result in unbiased estimates @bartlettAsymptoticallyUnbiasedEstimation2015.

Overstate the Race effect: Missingness in Race conditional on being in a county with \<50% White defendants & not being incarcerated OR being in county with \>90% White defendants & being incarcerated. $$P[\mathrm{RACE ~is ~Miss} ~|~ (\mathrm{County ~is~<50\% ~ WHITE}, ~\mathrm{INCAR} = 0) \cup (\mathrm{County ~is~>90\% ~ WHITE}, ~\mathrm{INCAR} = 1)] = .2$$

Understate the Race effect: Missingness in Race is conditional on being in a county with \<50% White defendants & being incarcerated OR being in a county with \>90% White defendants & not being incarcerated.

$$P[\mathrm{RACE ~is ~Miss} ~|~ (\mathrm{County ~is~<50\% ~ WHITE}, ~\mathrm{INCAR} = 1) \cup (\mathrm{County ~is~>90\% ~ WHITE}, ~\mathrm{INCAR} = 0)] = .2$$

```{r mar-sim}
cl <- makeCluster(cores[1] - 1)
registerDoParallel(cl)
ptime <- system.time({
    mar <- foreach(i = 1:5, .combine = rbind) %dopar% {
    source("helpers.R")
    full_sim(miss_type = "MAR", sim_size = "full", pop_data = dat,
             beta = beta, a = a[2], b = b[2], Q = Q, replace = replace)
    }
})[3]
ptime
stopCluster(cl)
```

------------------------------------------------------------------------

## Results

### Tables

```{r, echo = FALSE}
sim.res <- rbind(mnar, mar)

tbs <- result_tables(sim.res)
tbs$ODDS_RATIO
tbs$PROP_MISS
tbs$DIFF
tbs$BIAS
```

### Plots

```{r echo = FALSE}
plts <- result_plots(sim.res)

cowplot::plot_grid(plts$OR, plts$PM, nrow = 2)

cowplot::plot_grid(plts$DIFF, plts$BIAS, nrow = 2)
```

```{r echo = FALSE}
# or_bias_diff <- ggplot(sim.res, aes(x = OR_BIAS, y = OR_DIFF, color = DIRECTION)) +
#     geom_point() +
#     facet_grid(MISS_TYPE ~ DIRECTION)
# 
# cowplot::plot_grid(bias_plt, or_bias_diff, nrow = 2)
```
