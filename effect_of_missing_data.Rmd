---
title: 'Small Simulation: Effect of Missing Data'
author: "Ben Stockton"
date: "`r Sys.Date()`"
output: 
    html_document:
    number_sections: true 
    df_print: tibble
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = 'hold', cache = TRUE)

library(ggplot2)
library(cowplot)
library(latex2exp)
library(dplyr)
library(doParallel)

cores <- detectCores()

source("helpers.R")
```

## Simulation Process

Set $\beta = (\beta_0, \beta_X, ...)'$ and `Q` the number of iterations.

For each iteration `q`:

1. Generate a new data set containing $Y$, $X$, and $CTY$. 

    - $CTY$ is a "county" variable with four levels. Level 3 is the reference level.
    - $X$ is binary variable whose effect is of interest. 
    - $Y$ is randomly drawn from the Bernoulli distribution with probability $$(1 + \exp(-(1, X, CTY) \beta))^{-1}$$

2. Missingness is then generated in $X$ to create "Overstated" (OVER) and "Understated" (UNDR) X effects based on the type of missingness (MAR/MNAR).
3. Logistic regressions $logit(E(Y)) = (1, X, CTY)\beta$ are fit on the complete simulated data set, the OVER data set, and the UNDR data set. For each regression, the Odds Ratio and Proportion of Missingness are recorded and used to calculate the Bias $\hat{OR}_{MissType} - \beta_X$ and difference between the missing data set estimate and the complete data set estimate $\hat{OR}_{MissType} - \hat{OR}_{Comp}$.
4. Repeat for `Q` iterations.

## Test

Testing the simulation helper functions. First is the function to generate simulated data:
```{r}
set.seed(987)
M <- 1000
beta <- c("Intercept" = .05, 
          "X" = 0.25, 
          "C1" = -.2, 
          "C2" = 0,
          "C4" = .5)

test.df <- generate_data(beta = beta, M = M)
test.df %>% head()
```

```{r}
test.df %>% dummify_data_matrix(.)
```


Then generation of missingness in $X$:

```{r}
miss_pars <- matrix(data = NA, ncol = 2, nrow = 7)
colnames(miss_pars) <- c("OVER", "UNDR")
miss_pars[,"OVER"] <- c(-6, 2, 0, 0, 0, 2, 0)
miss_pars[,"UNDR"] <- c(-6, 2, 0, 0, 0, 2, 0)

x.miss <- generate_missing_x(test.df, "MAR", miss_pars = miss_pars)
str(x.miss)
x.miss[["UNDR"]][1:10]
```

```{r}
logits <- -2 * 1:4
(1 + exp(-logits))^-1
table(test.df$X, test.df$Y)
```


Testing each logistic regression which returns the $(OddsRatio, PropMiss)'$:
```{r}
sim_log_reg(test.df, x.miss, "COMP", sim_size = "small")
sim_log_reg(test.df, x.miss, "OVER", sim_size = "small")
sim_log_reg(test.df, x.miss, "UNDR", sim_size = "small")
```

Testing the full simulation:

```{r}
source("helpers.R")
miss_pars_mnar <- matrix(data = NA, ncol = 2, nrow = 7)
colnames(miss_pars_mnar) <- c("OVER", "UNDR")
miss_pars_mnar[,"OVER"] <- c(-6, -2, 0, 0, 0, 2, 0)
miss_pars_mnar[,"UNDR"] <- c(-6, 2, 0, 0, 0, 2, 0)

miss_pars_mar <- matrix(data = NA, ncol = 2, nrow = 7)
colnames(miss_pars_mar) <- c("OVER", "UNDR")
miss_pars_mar[,"OVER"] <- c(-6, 4, 0, 0, 0, 0, 0)
miss_pars_mar[,"UNDR"] <- c(-6, -4, 0, 0, 0, 0, 0)

full_sim(miss_type = "MNAR", beta = beta, Q = 1, miss_pars = miss_pars_mnar)
full_sim(miss_type = "MAR", beta = beta, Q = 1, miss_pars = miss_pars_mar)
```

---

## Simulation Settings

```{r setting-sim-params}
source("helpers.R")
M <- 1000
Q <- 25
beta <- c("Intercept" = .05, 
          "X" = 0.25, 
          "C1" = -.2, 
          "C2" = 0,
          "C4" = .5)
```

- Sample size $M = $ `r M`
- $beta = $ `r beta`
- $(a, b, c) = $ `r miss_pars`

## MNAR

Want to get roughly 3-5% missing in X in both cases.

Overstate the X effect:

$$p_i = P(X_i ~ Missing | Y_i, X_i) = [1 + \exp(-(a + b (1 - X_i) Y_i))]^{-1}$$

Understate the X effect:

$$p_i = P(X_i ~ Missing | Y_i, X_i) = [1 + \exp(-(a+b (1 - X_i) (1 - Y_i)))]^{-1}$$

For both cases we set `a` to `r a` and `b` to `r b` to get between 3-5% missingness in $X$. 

For example, setting $a = -4.25$ and $b = 2$, we get $P(X_i ~ Missing | Y_i, X_i) = 0.095$ and $P(X_i ~ Missing | Y_i, X_i) = 0.014$ resulting in roughly 3-5% missing in $X$.

With these probabilities for each observation, draw from a $Bernoulli(p_i)$ distribution for each observation to determine if $X_i$ is missing.

```{r mnar-sim}
miss_pars_mnar <- matrix(data = NA, ncol = 2, nrow = 7)
colnames(miss_pars_mnar) <- c("OVER", "UNDR")
miss_pars_mnar[,"OVER"] <- c(-4.5, -3, 0, 0, 0, 3, 0)
miss_pars_mnar[,"UNDR"] <- c(-8, 3, 0, 0, 0, 3, 0)

cl <- makeCluster(cores[1] - 1)
registerDoParallel(cl)
ptime <- system.time({
    mnar <- foreach(i = 1:6, .combine = rbind) %dopar% {
        source("helpers.R")
        full_sim(miss_type = "MNAR", beta = beta,
                 Q = Q, miss_pars = miss_pars_mnar)
    }
})[3]
ptime
stopCluster(cl)
```

---

## MAR

Want to get roughly 3% missing in X in both cases.

Overstate the X effect:

Let $Z_{i1} = ((1-C2_i)(1 - Y_i)) + (C1_i Y_i)$

$$p_{i1} = P(X_i ~ Missing | Y_i, X_i) = [1 + \exp(-(a + b Z_{i1}))]^{-1}$$

Understate the X effect:

Let $Z_{i2} = ((1-C1_i)(1 - Y_i)) + (C4_i Y_i)$

$$p_{i2} = P(X_i ~ Missing | Y_i, X_i) = [1 + \exp(-(a + b Z_{i2}))]^{-1}$$

```{r mar-sim}
miss_pars_mar <- matrix(data = NA, ncol = 2, nrow = 7)
colnames(miss_pars_mar) <- c("OVER", "UNDR")
miss_pars_mar[,"OVER"] <- c(-3.5, -4, 2, .75, -1, 0, 0)
miss_pars_mar[,"UNDR"] <- c(-3.75, 2, -.5, -.75, .5, 0, 0)

cl <- makeCluster(cores[1] - 1)
registerDoParallel(cl)
stime <- system.time({
    mar <- foreach(i = 1:6, .combine = rbind) %dopar% {
        source("helpers.R")
        full_sim(miss_type = "MAR", beta = beta,
                 Q = Q, miss_pars = miss_pars_mar)
    }
})[3]
stime
stopCluster(cl)
```

---

## Results

### Tables

```{r, echo = FALSE}
sim.res <- rbind(mnar, mar)

tbs <- result_tables(sim.res)
tbs$ODDS_RATIO
tbs$PROP_MISS
tbs$DIFF
tbs$BIAS
```


### Plots

```{r echo = FALSE}
plts <- result_plots(sim.res)

cowplot::plot_grid(plts$OR, plts$PM, nrow = 2)

cowplot::plot_grid(plts$DIFF, plts$BIAS, nrow = 2)
```



```{r echo = FALSE}
# or_bias_diff <- ggplot(sim.res, aes(x = OR_BIAS, y = OR_DIFF, color = DIRECTION)) +
#     geom_point() +
#     facet_grid(MISS_TYPE ~ DIRECTION)
# 
# cowplot::plot_grid(bias_plt, or_bias_diff, nrow = 2)
```

